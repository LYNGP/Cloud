# 多线程TCP服务器 - README

## 项目概述

这是一个基于C语言实现的多线程TCP服务器，采用线程池模式处理客户端连接。服务器支持文件上传下载、目录浏览等功能，使用epoll进行高效的I/O多路复用。

## 项目架构

### 核心文件结构

```
├── server.c          # 主服务器程序
├── worker.c           # 工作线程实现
├── tcpInit.c          # TCP网络初始化
├── epollAdd.c         # epoll事件管理
├── queue.c            # 任务队列实现
├── recvFile.c         # 文件接收功能
├── sendFile.c         # 文件发送功能
├── func.h             # 函数声明和数据结构定义
└── bin/               # 可执行文件目录
```

## 文件功能详解

### 1. server.c - 主服务器
**功能**：程序入口和主控制逻辑
- 创建父子进程，父进程处理信号，子进程运行服务器
- 初始化线程池和网络服务
- 使用epoll监听新连接和退出信号
- 将新连接分发给工作线程处理

**关键特性**：
- 支持优雅退出（SIGUSR1信号）
- epoll事件驱动模型
- 线程池任务分发

### 2. worker.c - 工作线程
**功能**：处理客户端请求的工作线程
- 从任务队列获取客户端连接
- 解析客户端命令（cd、ls、puts、gets）
- 执行相应的文件操作或目录操作
- 发送响应结果给客户端

**支持的命令**：
- `cd <path>` - 切换目录
- `ls` - 列出当前目录内容
- `puts <filename>` - 上传文件到服务器
- `gets <filename>` - 从服务器下载文件

### 3. tcpInit.c - 网络初始化
**功能**：TCP服务器socket初始化
- 创建socket并绑定到指定IP和端口
- 设置socket选项（SO_REUSEADDR）
- 开始监听客户端连接

### 4. epollAdd.c - epoll管理
**功能**：epoll事件管理
- 将文件描述符添加到epoll实例
- 配置为边缘触发模式（EPOLLET）
- 监听可读事件（EPOLLIN）

### 5. queue.c - 任务队列
**功能**：线程安全的任务队列实现
- 入队操作（EnQueue）：添加新的客户端连接
- 出队操作（DeQueue）：工作线程获取任务
- 循环队列结构，支持并发访问

### 6. recvFile.c - 文件接收
**功能**：处理客户端文件上传
- 接收文件名和文件大小信息
- 创建目标文件并接收文件数据
- 支持大文件传输
- 错误处理和状态反馈

### 7. sendFile.c - 文件发送
**功能**：处理客户端文件下载请求
- 检查文件是否存在
- 发送文件大小信息
- 逐块读取并发送文件内容
- 传输完成确认

### 8. func.h - 头文件
**功能**：项目的核心数据结构和函数声明
- 线程池结构体定义
- 任务队列结构体定义
- 全局变量声明
- 函数原型声明

## 编译和运行

### 编译
```bash
make
```

### 运行服务器
```bash
./bin/server <IP地址> <端口> <工作线程数>
```

**示例**：
```bash
./bin/server 0.0.0.0 8080 3
```

### 停止服务器
```bash
kill -SIGUSR1 <服务器进程PID>
```

## 客户端使用

可以使用telnet或自定义客户端连接：
```bash
telnet localhost 8080
```

**支持的命令**：
- `cd /path/to/directory` - 切换到指定目录
- `ls` - 列出当前目录文件
- `puts filename` - 上传文件
- `gets filename` - 下载文件

## 技术特点

### 并发模型
- **线程池模式**：预创建固定数量的工作线程
- **任务队列**：主线程接收连接，工作线程处理业务
- **epoll多路复用**：高效处理大量并发连接

### 安全特性
- 线程安全的任务队列操作
- 优雅的进程退出处理
- 错误处理和资源清理

### 性能优化
- 使用epoll边缘触发模式
- 避免频繁的线程创建销毁
- 高效的文件传输机制

## 注意事项

1. **权限要求**：服务器需要对工作目录有读写权限
2. **端口占用**：确保指定端口未被其他程序占用
3. **防火墙设置**：需要开放服务器监听端口
4. **文件大小限制**：大文件传输时需要注意内存使用
5. **并发连接数**：工作线程数量影响并发处理能力

## 扩展功能建议

- 添加用户认证机制
- 实现文件权限检查
- 支持断点续传
- 添加日志记录功能
- 实现配置文件支持